<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Island Conquest</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <style>
        * {
          box-sizing: border-box;
          -webkit-tap-highlight-color: transparent;
        }

        body {
          font-family: 'Courier New', monospace;
          padding: 10px;
          text-align: center;
          background: linear-gradient(135deg, #1e3a5f 0%, #2a5a8f 50%, #1a4d7a 100%);
          min-height: 100vh;
          margin: 0;
          position: relative;
          overflow-x: hidden;
        }

        body::before {
          content: '';
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-image:
            repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(100, 200, 255, 0.03) 2px, rgba(100, 200, 255, 0.03) 4px),
            repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(100, 200, 255, 0.03) 2px, rgba(100, 200, 255, 0.03) 4px);
          pointer-events: none;
          z-index: 0;
        }

        h1 {
          color: #f4e5c2;
          text-shadow: 0 0 20px rgba(244, 229, 194, 0.8), 2px 2px 4px rgba(0, 0, 0, 0.5);
          font-family: 'Courier New', monospace;
          letter-spacing: 3px;
          z-index: 1;
          position: relative;
          font-size: clamp(1.5rem, 5vw, 2.5rem);
          margin: 10px 0;
        }

        h1::before {
          content: '⚓ ';
          color: #8b6f47;
        }

        h1::after {
          content: ' ⚓';
          color: #8b6f47;
        }

        #map-container {
          position: relative;
          max-width: 650px;
          min-height: 500px;
          height: 600px;
          margin: 20px auto;
          padding: 40px;
          background: linear-gradient(135deg, #1a4d7a 0%, #2a5a8f 50%, #1e3a5f 100%);
          border: 3px solid #5a9fd4;
          border-radius: 12px;
          box-shadow: 0 0 30px rgba(90, 159, 212, 0.4), inset 0 0 50px rgba(0, 0, 0, 0.3);
          z-index: 1;
          overflow: hidden;
        }

        #map-container::before {
          content: '~ OCEAN ~';
          position: absolute;
          top: 10px;
          left: 50%;
          transform: translateX(-50%);
          background: #1a4d7a;
          padding: 5px 15px;
          color: #5a9fd4;
          font-size: clamp(10px, 2.5vw, 12px);
          font-weight: bold;
          letter-spacing: 3px;
          border: 1px solid #5a9fd4;
          border-radius: 4px;
          z-index: 5;
        }

        .wave {
          position: absolute;
          width: 100%;
          height: 3px;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
          animation: wave-move 4s ease-in-out infinite;
          pointer-events: none;
        }

        .wave:nth-child(1) {
          top: 20%;
          animation-delay: 0s;
        }

        .wave:nth-child(2) {
          top: 40%;
          animation-delay: 1.3s;
        }

        .wave:nth-child(3) {
          top: 60%;
          animation-delay: 2.6s;
        }

        .wave:nth-child(4) {
          top: 80%;
          animation-delay: 0.7s;
        }

        @keyframes wave-move {
          0%, 100% {
            transform: translateX(-100%);
            opacity: 0;
          }
          50% {
            opacity: 0.5;
          }
        }

        .ripple {
          position: absolute;
          width: 20px;
          height: 20px;
          border: 2px solid rgba(255, 255, 255, 0.2);
          border-radius: 50%;
          animation: ripple-expand 3s ease-out infinite;
          pointer-events: none;
        }

        @keyframes ripple-expand {
          0% {
            transform: scale(0);
            opacity: 1;
          }
          100% {
            transform: scale(3);
            opacity: 0;
          }
        }

        #map {
          position: relative;
          width: 100%;
          height: 100%;
          display: block;
          margin: 0 auto;
          z-index: 2;
        }

        .cell {
          position: absolute;
          border: 2px solid #8b6f47;
          cursor: pointer;
          background: linear-gradient(135deg, #4a7c2c 0%, #5a9635 50%, #3d6424 100%);
          user-select: none;
          touch-action: manipulation;
          transition: all 0.3s ease;
          overflow: hidden;
          box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3), 0 2px 5px rgba(0, 0, 0, 0.4);
          border-radius: 8px;
        }

        .cell::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 200, 0.3), transparent);
          transition: left 0.5s;
          pointer-events: none;
        }

        .cell:hover::before,
        .cell:active::before {
          left: 100%;
        }

        .cell:hover,
        .cell:active {
          border-color: #f4e5c2;
          box-shadow: 0 0 20px rgba(244, 229, 194, 0.5), inset 0 0 20px rgba(244, 229, 194, 0.1);
          transform: scale(1.05);
          z-index: 10;
        }

        .cell::after {
          content: '';
          position: absolute;
          top: 5px;
          left: 5px;
          right: 5px;
          bottom: 5px;
          border: 1px solid rgba(139, 111, 71, 0.3);
          pointer-events: none;
          border-radius: 4px;
        }

        .cell span {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-weight: bold;
          font-size: clamp(10px, 2.5vw, 14px);
          color: #2d1f0f;
          text-shadow: 0 0 5px rgba(244, 229, 194, 0.5);
          z-index: 1;
          font-family: 'Courier New', monospace;
        }

        .cell.mountain {
          background: linear-gradient(135deg, #3d3d3d 0%, #555555 50%, #2a2a2a 100%);
        }

        .cell.beach {
          background: linear-gradient(135deg, #f4e5c2 0%, #d4c5a2 50%, #c4b592 100%);
        }

        .cell.water {
          background: linear-gradient(135deg, #2a5a8f 0%, #3a6a9f 50%, #1a4d7a 100%);
          border-color: #5a9fd4;
        }

        .buttons-container {
          display: flex;
          gap: 15px;
          z-index: 1;
          position: relative;
          flex-wrap: wrap;
          justify-content: center;
        }

        button {
          padding: 12px 20px;
          font-size: clamp(14px, 3.5vw, 16px);
          margin-top: 10px;
          border-radius: 5px;
          font-family: 'Courier New', monospace;
          background: linear-gradient(135deg, #8b6f47 0%, #a58a5f 100%);
          color: #f4e5c2;
          border: 2px solid #6a5437;
          cursor: pointer;
          transition: all 0.3s;
          font-weight: bold;
          text-transform: uppercase;
          letter-spacing: 1px;
          min-width: 120px;
          touch-action: manipulation;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        button:hover,
        button:active {
          background: linear-gradient(135deg, #a58a5f 0%, #c4aa7f 100%);
          box-shadow: 0 0 20px rgba(244, 229, 194, 0.6);
          transform: translateY(-2px);
        }

        button:active {
          transform: translateY(0);
        }

        input {
          background: #1a4d7a;
          border: 2px solid #5a9fd4;
          color: #f4e5c2;
          padding: 10px;
          font-size: 16px;
          border-radius: 5px;
          width: 100%;
          max-width: 300px;
          font-family: 'Courier New', monospace;
        }

        input:focus {
          outline: none;
          box-shadow: 0 0 10px rgba(90, 159, 212, 0.5);
        }

        select {
          background: #1a4d7a;
          border: 2px solid #5a9fd4;
          color: #f4e5c2;
          padding: 10px;
          font-size: 16px;
          border-radius: 5px;
          width: 100%;
          max-width: 300px;
          font-family: 'Courier New', monospace;
        }

        select:focus {
          outline: none;
          box-shadow: 0 0 10px rgba(90, 159, 212, 0.5);
        }

        .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgba(10, 30, 50, 0.95);
          backdrop-filter: blur(5px);
          padding: 20px;
          animation: fadeIn 0.3s ease;
        }

        .modal.closing {
          animation: fadeOut 0.3s ease;
        }

        .modal-content {
          background: linear-gradient(145deg, #1a4d7a 0%, #2a5a8f 100%);
          margin: 10% auto;
          padding: 30px 20px;
          border: 3px solid #5a9fd4;
          width: 90%;
          max-width: 400px;
          text-align: center;
          border-radius: 8px;
          box-shadow: 0 0 40px rgba(90, 159, 212, 0.4);
          animation: slideDown 0.4s ease;
          position: relative;
        }

        .modal-content h3 {
          color: #f4e5c2;
          text-shadow: 0 0 15px rgba(244, 229, 194, 0.8);
          font-family: 'Courier New', monospace;
          letter-spacing: 2px;
          margin-bottom: 25px;
          font-size: clamp(1.2rem, 4vw, 1.5rem);
        }

        .modal-content button {
          width: 100%;
          margin: 10px 0;
        }

        .modal-content p {
          margin: 15px 0;
          color: #f4e5c2;
        }

        .modal-buttons {
          display: flex;
          flex-direction: column;
          gap: 10px;
        }

        #players {
          margin-top: 20px;
          font-size: clamp(14px, 3.5vw, 16px);
          background: linear-gradient(145deg, #1a4d7a 0%, #2a5a8f 100%);
          padding: 15px;
          border-radius: 8px;
          max-width: 90%;
          width: 400px;
          margin-left: auto;
          margin-right: auto;
          box-shadow: 0 0 20px rgba(90, 159, 212, 0.2);
          border: 2px solid #5a9fd4;
          color: #f4e5c2;
          z-index: 1;
          position: relative;
          word-wrap: break-word;
        }

        #status {
          margin-top: 10px;
          font-weight: bold;
          background: linear-gradient(145deg, #1a4d7a 0%, #2a5a8f 100%);
          padding: 10px;
          border-radius: 8px;
          max-width: 90%;
          width: 400px;
          margin-left: auto;
          margin-right: auto;
          box-shadow: 0 0 20px rgba(90, 159, 212, 0.2);
          border: 2px solid #5a9fd4;
          color: #f4e5c2;
          z-index: 1;
          position: relative;
          font-size: clamp(14px, 3.5vw, 16px);
        }

        #puzzle-panel {
          display: none;
          margin-top: 20px;
          padding: 20px 15px;
          border: 3px solid #5a9fd4;
          background: linear-gradient(145deg, #1a4d7a 0%, #2a5a8f 100%);
          max-width: 95%;
          width: 100%;
          margin-left: auto;
          margin-right: auto;
          border-radius: 8px;
          box-shadow: 0 0 30px rgba(90, 159, 212, 0.4);
          color: #f4e5c2;
          z-index: 1;
          position: relative;
        }

        #puzzle-panel h3 {
          color: #f4e5c2;
          text-shadow: 0 0 10px rgba(244, 229, 194, 0.6);
          font-size: clamp(1.1rem, 4vw, 1.3rem);
          margin-bottom: 15px;
        }

        #puzzle-panel p {
          font-size: clamp(14px, 3.5vw, 16px);
          margin-bottom: 15px;
        }

        .close {
          color: #f4e5c2;
          position: absolute;
          top: 10px;
          right: 20px;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
          transition: color 0.3s;
          z-index: 10;
        }

        .close:hover,
        .close:focus,
        .close:active {
          color: #5a9fd4;
          text-shadow: 0 0 10px rgba(90, 159, 212, 0.8);
        }

        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }

        @keyframes fadeOut {
          from { opacity: 1; }
          to { opacity: 0; }
        }

        @keyframes slideDown {
          from { transform: translateY(-50px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }

        @keyframes victoryPulse {
          0%, 100% {
            transform: scale(1);
            text-shadow: 0 0 15px rgba(244, 229, 194, 0.8);
          }
          50% {
            transform: scale(1.05);
            text-shadow: 0 0 30px rgba(244, 229, 194, 1), 0 0 40px rgba(90, 159, 212, 0.8);
          }
        }

        @keyframes confettiFall {
          0% { transform: translateY(-800px) rotate(0deg); opacity: 1; }
          100% { transform: translateY(200px) rotate(720deg); opacity: 0; }
        }

        @keyframes glowPulse {
          0%, 100% {
            box-shadow: 0 0 40px rgba(90, 159, 212, 0.4);
            border-color: #5a9fd4;
          }
          50% {
            box-shadow: 0 0 60px rgba(244, 229, 194, 0.8), 0 0 80px rgba(90, 159, 212, 0.6);
            border-color: #f4e5c2;
          }
        }

        @keyframes starBurst {
          0% {
            transform: translate(0, 0) scale(0) rotate(0deg);
            opacity: 1;
          }
          100% {
            transform: translate(var(--tx), var(--ty)) scale(1) rotate(360deg);
            opacity: 0;
          }
        }

        .victory-text {
          animation: victoryPulse 1.5s ease-in-out infinite;
        }

        .confetti {
          position: absolute;
          width: 10px;
          height: 10px;
          background: #f4e5c2;
          animation: confettiFall 3s linear infinite;
        }

        .glow-pulse {
          animation: glowPulse 2s ease-in-out infinite;
        }

        .star {
          position: absolute;
          font-size: 24px;
          animation: starBurst 1s ease-out forwards;
          pointer-events: none;
        }

        @media (max-width: 768px) {
          body {
            padding: 5px;
          }

          h1 {
            letter-spacing: 1px;
            margin: 5px 0 10px;
          }

          #map-container {
            padding: 30px 20px;
            margin-top: 15px;
            height: 500px;
            min-height: 400px;
          }

          button {
            padding: 10px 15px;
            min-width: 100px;
          }

          .modal {
            padding: 10px;
          }

          .modal-content {
            padding: 25px 15px;
            margin: 20% auto;
          }

          #puzzle-panel {
            padding: 15px 10px;
          }

          #players,
          #status {
            padding: 12px;
          }
        }

        @media (max-width: 480px) {
          #map-container {
            padding: 25px 15px;
            height: 450px;
          }

          button {
            padding: 10px;
            min-width: 90px;
            font-size: 14px;
          }

          .modal-content {
            width: 95%;
            padding: 20px 15px;
          }
        }

        @media (max-height: 500px) and (orientation: landscape) {
          h1 {
            font-size: 1.3rem;
            margin: 5px 0;
          }

          .modal-content {
            margin: 5% auto;
            max-height: 90vh;
            overflow-y: auto;
          }
        }
    </style>
</head>
<body>
<h1>Island Conquest</h1>

<div id="roleModal" style="display: block;">
    <div id="roleModalContent" class="modal-content">
        <h3>Choose your role</h3>
        <button id="playerButton">Play as Player</button>
        <button id="spectatorButton">Play as Spectator</button>
        <button id="backButton" style="display: none;">Back</button>
    </div>
</div>

<div id="surrenderModal" class="modal">
    <div class="modal-content glow-pulse">
        <h3 class="victory-text">Victory!</h3>
        <p style="font-size: 18px;" id="declareWinner">Congratulations, your competitor has surrendered</p>
        <button>Continue</button>
    </div>
</div>

<div id="phaseModal" class="modal">
    <div class="modal-content">
        <h3>Phase Complete</h3>
        <p style="font-size: 18px;" id="declarePhase">The first phase is completed. Prepare for the revenge phase.</p>
    </div>
</div>

<div id="status"></div>
<div id="players"></div>

<div id="map-container">
    <div class="wave"></div>
    <div class="wave"></div>
    <div class="wave"></div>
    <div class="wave"></div>
    <div id="map"></div>
</div>

<div id="puzzle-panel">
    <h3 id="puzzle-title"></h3>
    <p id="puzzle-question">What is 2 + 2?</p>
    <input type="text" id="puzzle-answer">
    <br>
    <button onclick="submitAnswer()">Submit Answer</button>
</div>

<script>
    let socket = null;
    let playerName = "";
    let playerRole = "";
    let selectedRoom = "";
    let playerColor = "";
    let gameStarted = false;
    let rooms = ["Room1", "Room2", "Room3", "Room4"];
    let playersInRooms = {};
    let connected = "first";
    let selectedCellId = null;

    const puzzles = [
        { question: "What is 11 + 3?", answer: "14" },
        { question: "What is 14 - 6?", answer: "8" },
        { question: "What is 7 x 2?", answer: "14" },
        { question: "What is 20 ÷ 4?", answer: "5" },
        { question: "What comes after 29?", answer: "30" },
        { question: "What is 5 squared?", answer: "25" },
        { question: "What is the square root of 81?", answer: "9" },
        { question: "If you have 3 apples and eat 1, how many?", answer: "2" },
        { question: "Which number is even: 3 or 4?", answer: "4" },
        { question: "What is 100 - 75?", answer: "25" },
        { question: "What is 8 + 6?", answer: "14" },
        { question: "What is 18 ÷ 3?", answer: "6" },
        { question: "What is 6 x 6?", answer: "36" },
        { question: "What is 15 - 7?", answer: "8" },
        { question: "What is 7 + 8?", answer: "15" },
        { question: "What is 9 x 1?", answer: "9" },
        { question: "What is 24 ÷ 8?", answer: "3" },
        { question: "What is 12 + 5?", answer: "17" },
        { question: "What is 3 x 5?", answer: "15" },
        { question: "What is 10 - 4?", answer: "6" },
        { question: "What is 6 ÷ 3?", answer: "2" },
        { question: "If 2 + x = 5, what is x?", answer: "3" },
        { question: "What is 4 x 4?", answer: "16" },
        { question: "What is 20 ÷ 2?", answer: "10" },
        { question: "What is 2²?", answer: "4" }
    ];

    let currentPuzzle = null;

    const islandCells = [
        { id: 0, left: '8%', top: '8%', width: '70px', height: '55px', type: 'land' },
        { id: 1, left: '20%', top: '5%', width: '60px', height: '50px', type: 'mountain' },
        { id: 2, left: '35%', top: '3%', width: '75px', height: '60px', type: 'land' },
        { id: 3, left: '52%', top: '7%', width: '65px', height: '52px', type: 'land' },
        { id: 4, left: '68%', top: '4%', width: '58px', height: '48px', type: 'mountain' },

        { id: 5, left: '5%', top: '18%', width: '68px', height: '58px', type: 'beach' },
        { id: 6, left: '18%', top: '16%', width: '72px', height: '62px', type: 'land' },
        { id: 7, left: '33%', top: '15%', width: '70px', height: '60px', type: 'land' },
        { id: 8, left: '49%', top: '18%', width: '66px', height: '56px', type: 'mountain' },
        { id: 9, left: '66%', top: '16%', width: '64px', height: '54px', type: 'land' },

        { id: 10, left: '3%', top: '31%', width: '62px', height: '58px', type: 'land' },
        { id: 11, left: '16%', top: '30%', width: '75px', height: '65px', type: 'land' },
        { id: 12, left: '32%', top: '29%', width: '68px', height: '62px', type: 'beach' },
        { id: 13, left: '48%', top: '32%', width: '70px', height: '60px', type: 'land' },
        { id: 14, left: '65%', top: '30%', width: '66px', height: '58px', type: 'mountain' },

        { id: 15, left: '7%', top: '45%', width: '64px', height: '56px', type: 'land' },
        { id: 16, left: '21%', top: '44%', width: '70px', height: '62px', type: 'mountain' },
        { id: 17, left: '37%', top: '43%', width: '68px', height: '60px', type: 'land' },
        { id: 18, left: '53%', top: '46%', width: '65px', height: '58px', type: 'land' },
        { id: 19, left: '69%', top: '44%', width: '62px', height: '55px', type: 'beach' },

        { id: 20, left: '12%', top: '58%', width: '66px', height: '58px', type: 'beach' },
        { id: 21, left: '26%', top: '57%', width: '68px', height: '60px', type: 'land' },
        { id: 22, left: '41%', top: '56%', width: '72px', height: '62px', type: 'land' },
        { id: 23, left: '58%', top: '59%', width: '64px', height: '56px', type: 'mountain' },
        { id: 24, left: '73%', top: '57%', width: '60px', height: '54px', type: 'land' }
    ];

    window.onload = function() {
        connectWebSocket();
        document.getElementById('roleModal').style.display = "block";

        document.getElementById('playerButton').addEventListener('click', function() {
            playerRole = "player";
            showRoomSelection();
            backButton.style.display = 'block';
        });

        document.getElementById('spectatorButton').addEventListener('click', function() {
            playerRole = "spectator";
            showRoomSelection();
            backButton.style.display = 'block';
        });

        createOceanRipples();
    };

    function createOceanRipples() {
        const container = document.getElementById('map-container');
        setInterval(() => {
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            ripple.style.left = Math.random() * 100 + '%';
            ripple.style.top = Math.random() * 100 + '%';
            ripple.style.animationDelay = Math.random() * 2 + 's';
            container.appendChild(ripple);
            setTimeout(() => ripple.remove(), 3000);
        }, 2000);
    }

    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        socket = new WebSocket(`${protocol}//${host}/game`);

        socket.onopen = () => {
            if (connected === "first") {
                connected = "connected";
            }
            if (connected === "lost") {
                window.location.reload();
            }
            console.log("Connected to WebSocket");
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = "Connected";
        };

        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                console.log("Received:", data);
                handleServerMessage(data);
            } catch (e) {
                console.error("Invalid message from server:", event.data);
            }
        };

        socket.onclose = (ev) => {
            console.error("WebSocket closed:", ev);
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = "Connection lost...";
            connected = "lost";
            setTimeout(connectWebSocket, 3000);
        };

        socket.onerror = (error) => {
            console.error("WebSocket error:", error);
        };
    }

    const backButton = document.getElementById('backButton');

    function showRoleSelection() {
        const modalContent = document.getElementById('roleModalContent');
        modalContent.innerHTML = `<h3>Choose your role</h3>
            <button id="playerButton">Play as Player</button>
            <button id="spectatorButton">Play as Spectator</button>`;

        backButton.style.display = 'none';
        modalContent.appendChild(backButton);

        document.getElementById('playerButton').addEventListener('click', function() {
            playerRole = "player";
            showRoomSelection();
        });
        document.getElementById('spectatorButton').addEventListener('click', function() {
            playerRole = "spectator";
            showRoomSelection();
        });
    }

    backButton.addEventListener('click', function() {
        showRoleSelection();
    });

    function showRoomSelection() {
        const modalContent = document.getElementById('roleModalContent');

        modalContent.innerHTML = `
            <h3>Select a Room</h3>
            <select id="roomSelect"></select>
            <br><br>
            <label for="playerName" style="color: #f4e5c2;">Enter your name:</label>
            <br>
            <input type="text" id="playerName" maxlength="10" placeholder="Your name..." style="margin-top: 8px;">
            <br><br>
            <button id="joinRoomButton" onclick="joinSelectedRoom()">Join Room</button>
        `;

        backButton.style.display = 'block';
        modalContent.appendChild(backButton);

        const roomSelect = document.getElementById('roomSelect');
        rooms.forEach(room => {
            let playerCount = playersInRooms[room] || 0;
            if (playerRole === "spectator" || playerCount < 2) {
                const option = document.createElement('option');
                option.value = room;
                option.text = room;
                roomSelect.appendChild(option);
            }
        });
    }

    function joinSelectedRoom() {
        selectedRoom = document.getElementById('roomSelect').value;
        playerName = document.getElementById('playerName').value.trim();

        if (!playerName) {
            alert("Please enter a name before joining!");
            return;
        }

        if (!socket || socket.readyState !== WebSocket.OPEN) {
            alert("WebSocket not connected yet. Please wait a moment.");
            return;
        }

        socket.send(JSON.stringify({
            type: "check",
            roomName: selectedRoom,
            playerName: playerName,
            role: playerRole
        }));
    }

    document.querySelector('#surrenderModal button').addEventListener('click', function() {
        socket.send(JSON.stringify({
            type: "finish-room",
            roomName: selectedRoom,
        }));
    });

    function initializeMap() {
        const mapDiv = document.getElementById('map');
        mapDiv.innerHTML = '';

        islandCells.forEach(cell => {
            const cellDiv = document.createElement('div');
            cellDiv.className = `cell ${cell.type}`;
            cellDiv.dataset.index = cell.id;
            cellDiv.style.left = cell.left;
            cellDiv.style.top = cell.top;
            cellDiv.style.width = cell.width;
            cellDiv.style.height = cell.height;
            cellDiv.addEventListener('click', () => claimCell(cell.id));
            cellDiv.innerHTML = `<span>${cell.id + 1}</span>`;
            mapDiv.appendChild(cellDiv);
        });
    }

    function updateStatus() {
        const statusDiv = document.getElementById('status');

        if (gameStarted === false) {
            if (playerRole === 'spectator') {
                statusDiv.innerHTML = "Waiting for the players to join...";
            } else if (playerRole === 'player') {
                statusDiv.innerHTML = `Welcome ${playerName}, waiting for the other player to join...`;
            }
        } else if (gameStarted === true) {
            if (playerRole === 'spectator') {
                statusDiv.innerHTML = "Game Started! Enjoy watching!!";
            } else if (playerRole === 'player') {
                statusDiv.innerHTML = `Game Started! Your color: ${playerColor}`;
            }
        }
    }

    function handleServerMessage(data) {
        if (data.error) {
            console.error("Server error:", data.error);
            return;
        }

        if (data.type === "player_left" && gameStarted === true) {
            surrenderModal.style.display = 'block';

            const continueBtn = document.querySelector('#surrenderModal button');
            if (playerRole === "player") {
                continueBtn.style.display = 'block';
            } else {
                continueBtn.style.display = 'none';
                document.getElementById("declareWinner").innerText = "The game came to an end, the other competitor has surrendered";
            }

            createConfetti();
            createStarBurst();
        }

        if (data.type === "player_left" && gameStarted === false) {
            const playersDiv = document.getElementById('players');
            playersDiv.innerHTML = "";
        }

        if (data.type === "close_room") {
            window.location.reload();
        }

        if (data.type === "check_result") {
            switch (data.status) {
                case 'full':
                    alert("The room is full!");
                    return;
                case 'already':
                    alert("The name already exists!");
                    return;
                case 'safe':
                    document.getElementById('roleModal').style.display = "none";

                    const joinMessage = {
                        roomName: selectedRoom,
                        playerName: playerName,
                        role: playerRole
                    };

                    initializeMap();

                    socket.send(JSON.stringify(Object.assign({type: "join_room"}, joinMessage)));
                    console.log("Sent join request:", joinMessage);
                    updateStatus();
                    break;
                default:
                    console.log('Unknown status');
            }
        }

        if (data.reset_close === true) {
            const surrenderModal = document.getElementById("surrenderModal");
            const phaseModal = document.getElementById("phaseModal");

            if (surrenderModal && surrenderModal.style.display !== "none") {
                surrenderModal.style.display = "none";
            }
            if (phaseModal && phaseModal.style.display !== "none") {
                phaseModal.style.display = "none";
            }
        }

        if (data.type === "room_update" || data.players || data.claimedLands) {
            const playersDiv = document.getElementById('players');
            let html = "";

            if (data.players) {
                const entries = Object.entries(data.players);
                html += "<strong>Players:</strong> " + entries.map(e => `${e[0]} (${e[1]})`).join(", ");
                if (playerName && data.players[playerName]) {
                    playerColor = data.players[playerName];
                }
                playersDiv.innerHTML = html;
            }

            if (typeof data.gameStarted !== 'undefined') {
                gameStarted = data.gameStarted;
            }

            if (data.claimedLands) {
                const claimed = data.claimedLands;
                for (const key in claimed) {
                    const idx = parseInt(key);
                    const col = claimed[key];
                    const cell = document.querySelector(`.cell[data-index='${idx}']`);
                    if (cell) {
                        if (col === null || col === undefined) {
                            cell.style.borderColor = "#8b6f47";
                        } else if (col === "red") {
                            cell.style.borderColor = "#ff6666";
                            cell.style.boxShadow = "0 0 15px rgba(255, 102, 102, 0.6)";
                        } else if (col === "blue") {
                            cell.style.borderColor = "#6666ff";
                            cell.style.boxShadow = "0 0 15px rgba(102, 102, 255, 0.6)";
                        } else {
                            cell.style.borderColor = "#ffffff";
                        }
                    }
                }
            }

            updateStatus();
        }

        if (data.type === "tile_update" && data.success) {
            const id = data.tileId;
            if(selectedCellId === id){
                document.getElementById('puzzle-panel').style.display = 'none';
            }
            const col = data.playerColor;
            const cell = document.querySelector(`.cell[data-index='${id}']`);
            if (cell) {
                if (col === null || col === undefined) {
                    cell.style.borderColor = "#8b6f47";
                } else if (col === "red") {
                    cell.style.borderColor = "#ff6666";
                    cell.style.boxShadow = "0 0 15px rgba(255, 102, 102, 0.6)";
                } else if (col === "blue") {
                    cell.style.borderColor = "#6666ff";
                    cell.style.boxShadow = "0 0 15px rgba(102, 102, 255, 0.6)";
                } else {
                    cell.style.borderColor = "#ffffff";
                }
            }

            if(data.count_lands === 25){
                phaseModal.style.display = 'block';
            }
        }
    }

    function claimCell(i) {
        if (playerRole === "spectator") return;

        if (!gameStarted) {
            alert("The game hasn't started yet!");
            return;
        }

        const cell = document.querySelector(`.cell[data-index='${i}']`);
        const currentBorder = cell.style.borderColor;

        if (currentBorder && currentBorder !== 'rgb(139, 111, 71)' && currentBorder !== '') {
            alert("This cell is already conquered!");
            return;
        }

        selectedCellId = i;
        showPuzzle(i);
    }

    function showPuzzle(cellIndex) {
        currentPuzzle = puzzles[cellIndex];

        document.getElementById('puzzle-title').innerText = `Puzzle for cell ${cellIndex + 1}`;
        document.getElementById('puzzle-question').innerText = currentPuzzle.question;
        document.getElementById('puzzle-answer').value = '';
        document.getElementById('puzzle-panel').style.display = 'block';

        document.getElementById('puzzle-answer').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                document.querySelector('button[onclick="submitAnswer()"]').click();
            }
        });
    }

    function submitAnswer() {
        const answer = document.getElementById('puzzle-answer').value.trim();
        if (answer === "") {
            alert("Please enter an answer.");
            return;
        }

        if (answer === currentPuzzle.answer) {
            document.getElementById('puzzle-panel').style.display = 'none';

            socket.send(JSON.stringify({
                type: "select",
                roomName: selectedRoom,
                playerName: playerName,
                tileId: selectedCellId
            }));

            selectedCellId = null;
        } else {
            alert("Wrong answer, try again!");
        }
    }

    function createConfetti() {
        const modal = document.getElementById('surrenderModal');
        const colors = ['#f4e5c2', '#5a9fd4', '#8b6f47', '#a58a5f'];

        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                modal.appendChild(confetti);

                setTimeout(() => confetti.remove(), 5000);
            }, i * 50);
        }
    }

    function createStarBurst() {
        const modalContent = document.querySelector('#surrenderModal .modal-content');
        const stars = ['✨', '⭐', '🌟', '💫'];

        for (let i = 0; i < 12; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.textContent = stars[Math.floor(Math.random() * stars.length)];

            const angle = (i / 12) * Math.PI * 2;
            const distance = 150;
            const tx = Math.cos(angle) * distance;
            const ty = Math.sin(angle) * distance;

            star.style.setProperty('--tx', tx + 'px');
            star.style.setProperty('--ty', ty + 'px');
            star.style.left = '50%';
            star.style.top = '20%';

            modalContent.appendChild(star);

            setTimeout(() => star.remove(), 1000);
        }
    }
</script>
</body>
</html>
